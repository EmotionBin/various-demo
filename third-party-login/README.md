# 前端第三方登录

这里实现一些第三方登录的功能，比如 QQ 登录，微信登录，github 登录等  

因为第三方登录功能都是需要授权的，需要有一个合法的网站，所以我们本地调试是无法调用第三方登录的，因为拿不到他们的授权，所以我决定自己模拟一个第三方来进行本地的第三方登录  

这里会使用 node 和 vue，简单的搭建两套演示平台

1. `http://localhost:9527/index.html` 是一个登陆页面，可以想象成普通的登陆页面，就是用户最初进入的登陆页面  
2. `http://localhost:9528/index1.html` 也是一个登陆页面，**可以想象它是第三方平台的登陆(如微信、QQ 等)**  

在以上所有的登陆中，用户名和密码都没有进行校验，随意输入都可以登陆成功，为了演示方便  

因为只是写一个简单 demo，怎么方便怎么来，这里使用的都是 fetch 与 get 请求，后端没有使用 token 而是使用随机字符串进行校验，也是为了方便，demo 嘛，能看懂能实现功能就行~  

## 操作方法

开启 node 服务，浏览器打开 `http://localhost:9527/index.html`，点击 **第三方登录** 按钮，弹出一个框，随意输入用户名和密码，点击登录，出现**授权成功**页面，三秒后或者提前手动点击返回或者直接关闭该页面，在初始的登陆页面会登录成功，并显示用户信息(密码其实不应该显示的，这里为了演示都显示出来了)，整个第三方登录就完成了  

## 实现原理

点击第三方登录会打开一个新的页面，这个页面有一个参数 `redirect_uri`，就是登录成功后**重定向的地址**，注意这个地址需要使用 `window.encodeURIComponent()` 进行编码，用户在这个新的页面输入信息登录成功后，重定向到了指定页面，并携带参数 `code`，这个 `code` 是服务端给过来的临时票据，一般会有有效期(这里没有设置有效期)，在拿到这个临时票据 `code` 之后，需要默默带着这个 `code` 再请求一次服务端，拿到真正的凭证 `access_token`，把这个 token 写入 webStorage(localStorage 或 sessionStorage) 中，**从此，这个 access_token 就用于后期调用第三方平台 API 获取数据**，整个流程结束  

具体可以看这张图，引用自微信的文档，[传送门](https://developers.weixin.qq.com/doc/oplatform/Website_App/WeChat_Login/Wechat_Login.html)  

![wx.png](https://res.wx.qq.com/op_res/D0wkkHSbtC6VUSHX4WsjP5ssg5mdnEmXO8NGVGF34dxS9N1WCcq6wvquR4K_Hcut)  

## 具体细节

可能看到这里会有以下两个疑问:  

Q:为什么需要回调地址并拼接参数，而不是直接服务器返回信息?  

A:如果不用回调地址，服务器直接返回信息，有可能会被截获，导致一系列不可预知的后果，若通过回调地址并拼接上参数则相对安全，因为这个回调地址是事先定义好的，也就是说这个地址一定是我们这边自己的地址，不会是黑客的钓鱼网站，这样就保证了登录成功后我们能从页面的参数中拿到必要信息  

Q:为什么先拿到一个临时票据，再用临时票据换取真实凭证，而不是直接拿到真实凭证?

A:因为拿到的第一个票据是需要拼接在回调地址的参数上的，这是可以在页面地址 URL 直接暴露出来的，如果这时候直接给真实的凭证，则真实凭证就会被暴露出来，有可能被黑客利用，所以需要先返回一个临时的票据，客户端再通过这个临时的票据去获取真正的凭证  

## 微信登录

微信开发者文档地址: https://developers.weixin.qq.com/doc/  

微信公众平台地址: https://mp.weixin.qq.com  

微信开放平台地址:https://open.weixin.qq.com  

参考:https://blog.csdn.net/qq_34190023/article/details/81133619  